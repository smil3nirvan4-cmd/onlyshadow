# =============================================================================
# S.S.I. SHADOW - Deploy to Production
# =============================================================================
# Triggers: push to main (requires approval), manual dispatch
# Steps: Canary deployment (10% ‚Üí 50% ‚Üí 100%), Rollback on failure
# =============================================================================

name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_canary:
        description: 'Skip canary deployment (deploy 100% immediately)'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Force deploy even if tests fail'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  ENVIRONMENT: production

jobs:
  # ===========================================================================
  # PRE-FLIGHT CHECKS
  # ===========================================================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      previous_version: ${{ steps.version.outputs.previous }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check CI status
        id: check
        run: |
          # Check if CI passed for this commit
          CI_STATUS=$(gh run list --commit ${{ github.sha }} --workflow ci.yml --json conclusion -q '.[0].conclusion')
          
          if [[ "$CI_STATUS" == "success" ]] || [[ "${{ inputs.force_deploy }}" == "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "CI not passed or still running. Status: $CI_STATUS"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Get previous version
        id: version
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "previous=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous version: $PREV_TAG"

  # ===========================================================================
  # CANARY DEPLOYMENT (10%)
  # ===========================================================================
  canary-10:
    name: Canary Deploy (10%)
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_deploy == 'true' && inputs.skip_canary != 'true'
    environment: production-canary
    
    outputs:
      canary_url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Wrangler
        run: npm install -g wrangler@latest
      
      - name: Install and build Worker
        run: |
          cd workers/gateway
          npm ci
          npm run build
      
      - name: Deploy Canary (10% traffic)
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd workers/gateway
          
          # Deploy canary version
          wrangler deploy --env production-canary
          
          # Set traffic split (10% to canary)
          # This requires Cloudflare Traffic Splitting setup
          echo "Canary deployed with 10% traffic split"
          echo "url=https://ssi-shadow-canary.workers.dev" >> $GITHUB_OUTPUT
      
      - name: Wait for canary to stabilize
        run: sleep 60
      
      - name: Monitor canary metrics
        id: monitor
        run: |
          CANARY_URL="${{ steps.deploy.outputs.url }}"
          
          # Check error rate
          for i in {1..10}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$CANARY_URL/health")
            if [[ "$RESPONSE" != "200" ]]; then
              echo "Health check failed: $RESPONSE"
              echo "healthy=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            sleep 5
          done
          
          echo "Canary health checks passed"
          echo "healthy=true" >> $GITHUB_OUTPUT

  # ===========================================================================
  # CANARY VALIDATION
  # ===========================================================================
  canary-validate:
    name: Validate Canary
    runs-on: ubuntu-latest
    needs: canary-10
    if: needs.canary-10.result == 'success'
    
    outputs:
      passed: ${{ steps.validate.outputs.passed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          cd tests
          npm ci
      
      - name: Run canary smoke tests
        id: smoke
        run: |
          CANARY_URL="${{ needs.canary-10.outputs.canary_url }}"
          
          # Send test events
          for i in {1..20}; do
            RESPONSE=$(curl -s -X POST "$CANARY_URL/api/collect" \
              -H "Content-Type: application/json" \
              -d '{
                "event_name": "PageView",
                "event_id": "canary_test_'$i'_'$(date +%s)'",
                "url": "https://example.com/canary-test"
              }')
            
            if ! echo "$RESPONSE" | grep -q "event_id"; then
              echo "Event $i failed"
              exit 1
            fi
          done
          
          echo "All canary smoke tests passed"
      
      - name: Check error rate from logs
        id: validate
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # In production, you'd check Cloudflare Analytics API
          # For now, assume passed if smoke tests passed
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "Error rate within acceptable limits"

  # ===========================================================================
  # CANARY DEPLOYMENT (50%)
  # ===========================================================================
  canary-50:
    name: Canary Deploy (50%)
    runs-on: ubuntu-latest
    needs: [canary-10, canary-validate]
    if: needs.canary-validate.outputs.passed == 'true'
    environment: production-canary-50
    
    steps:
      - name: Increase traffic to 50%
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Increasing canary traffic to 50%"
          # Update traffic split configuration
          # wrangler ...
          sleep 30
      
      - name: Monitor 50% canary
        run: |
          CANARY_URL="${{ needs.canary-10.outputs.canary_url }}"
          
          # Check health for 2 minutes
          for i in {1..24}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$CANARY_URL/health")
            if [[ "$RESPONSE" != "200" ]]; then
              echo "Health check failed at 50% traffic"
              exit 1
            fi
            sleep 5
          done
          
          echo "50% canary stable"

  # ===========================================================================
  # FULL PRODUCTION DEPLOYMENT (100%)
  # ===========================================================================
  deploy-production:
    name: Deploy Production (100%)
    runs-on: ubuntu-latest
    needs: [preflight, canary-50]
    if: always() && (needs.canary-50.result == 'success' || inputs.skip_canary == 'true')
    environment: production
    
    outputs:
      worker_url: ${{ steps.deploy-worker.outputs.url }}
      dashboard_url: ${{ steps.deploy-dashboard.outputs.url }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Google Cloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
      
      - name: Install Wrangler
        run: npm install -g wrangler@latest
      
      # Deploy Worker
      - name: Deploy Worker to Production
        id: deploy-worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd workers/gateway
          npm ci
          npm run build
          
          wrangler deploy --env production
          echo "url=https://ssi-shadow.workers.dev" >> $GITHUB_OUTPUT
      
      # Set production secrets
      - name: Configure production secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd workers/gateway
          
          echo "${{ secrets.META_PIXEL_ID }}" | wrangler secret put META_PIXEL_ID --env production
          echo "${{ secrets.META_ACCESS_TOKEN }}" | wrangler secret put META_ACCESS_TOKEN --env production
          echo "${{ secrets.TIKTOK_PIXEL_ID }}" | wrangler secret put TIKTOK_PIXEL_ID --env production
          echo "${{ secrets.TIKTOK_ACCESS_TOKEN }}" | wrangler secret put TIKTOK_ACCESS_TOKEN --env production
          echo "${{ secrets.GA4_MEASUREMENT_ID }}" | wrangler secret put GA4_MEASUREMENT_ID --env production
          echo "${{ secrets.GA4_API_SECRET }}" | wrangler secret put GA4_API_SECRET --env production
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}" | wrangler secret put GCP_SERVICE_ACCOUNT --env production
      
      # Deploy Dashboard
      - name: Deploy Dashboard to Production
        id: deploy-dashboard
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd dashboard
          npm ci
          
          VITE_API_URL=https://ssi-shadow.workers.dev \
          VITE_ENVIRONMENT=production \
          npm run build
          
          npx wrangler pages deploy dist \
            --project-name=ssi-shadow-dashboard \
            --branch=production
          
          echo "url=https://ssi-shadow-dashboard.pages.dev" >> $GITHUB_OUTPUT
      
      # Update BigQuery
      - name: Update BigQuery schemas
        run: |
          cd bigquery
          
          for file in schemas/*.sql; do
            echo "Running $file..."
            bq query --use_legacy_sql=false --project_id=${{ secrets.GCP_PROJECT_ID }} < "$file" || true
          done
      
      # Run dbt
      - name: Run dbt transformations
        run: |
          pip install dbt-bigquery
          cd dbt
          
          dbt deps
          dbt run --target prod --profiles-dir .
          dbt test --target prod --profiles-dir .
      
      # Generate version
      - name: Generate version
        id: version
        run: |
          VERSION="v${{ github.run_number }}.$(date +%Y%m%d)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # ===========================================================================
  # POST-DEPLOYMENT VERIFICATION
  # ===========================================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          cd tests
          npm ci
          npx playwright install --with-deps chromium
      
      - name: Verify Worker health
        run: |
          WORKER_URL="${{ needs.deploy-production.outputs.worker_url }}"
          
          for i in {1..5}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$WORKER_URL/health")
            if [[ "$RESPONSE" != "200" ]]; then
              echo "Health check $i failed"
              sleep 10
            else
              echo "Health check $i passed"
            fi
          done
      
      - name: Verify event collection
        run: |
          WORKER_URL="${{ needs.deploy-production.outputs.worker_url }}"
          
          RESPONSE=$(curl -s -X POST "$WORKER_URL/api/collect" \
            -H "Content-Type: application/json" \
            -H "User-Agent: Mozilla/5.0 Chrome/120.0.0.0" \
            -d '{
              "event_name": "PageView",
              "event_id": "prod_verify_'$(date +%s)'",
              "url": "https://example.com/verify"
            }')
          
          if echo "$RESPONSE" | grep -q "event_id"; then
            echo "Production event collection verified!"
          else
            echo "WARNING: Event collection may have issues"
          fi
      
      - name: Run production E2E tests
        env:
          E2E_BASE_URL: ${{ needs.deploy-production.outputs.dashboard_url }}
        run: |
          cd tests
          npx playwright test tests/e2e/dashboard.spec.ts \
            --project=chromium \
            --grep="@production" \
            --reporter=html \
            || true
      
      - name: Upload verification results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: production-verification
          path: tests/test-results/
          retention-days: 7

  # ===========================================================================
  # CREATE RELEASE
  # ===========================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [deploy-production, verify-deployment]
    if: needs.verify-deployment.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [[ -n "$PREV_TAG" ]]; then
            CHANGES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.deploy-production.outputs.version }}
          release_name: Release ${{ needs.deploy-production.outputs.version }}
          body: |
            ## üöÄ Production Deployment
            
            **Version:** ${{ needs.deploy-production.outputs.version }}
            **Commit:** ${{ github.sha }}
            **Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            
            ### URLs
            - **Worker:** ${{ needs.deploy-production.outputs.worker_url }}
            - **Dashboard:** ${{ needs.deploy-production.outputs.dashboard_url }}
            
            ### Changes
            ${{ steps.changelog.outputs.changes }}
            
            ### Deployment Details
            - Canary deployment: ‚úÖ
            - Verification tests: ‚úÖ
            - BigQuery schemas: ‚úÖ
            - dbt transformations: ‚úÖ
          draft: false
          prerelease: false

  # ===========================================================================
  # ROLLBACK (if verification fails)
  # ===========================================================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: [preflight, deploy-production, verify-deployment]
    if: failure() && needs.deploy-production.result == 'success'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Wrangler
        run: npm install -g wrangler@latest
      
      - name: Rollback Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd workers/gateway
          
          echo "Rolling back to previous version..."
          wrangler rollback --env production
          
          echo "Rollback completed"
      
      - name: Notify rollback
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚ö†Ô∏è <b>ROLLBACK TRIGGERED</b>%0A%0AProduction deployment rolled back due to verification failure.%0A%0ACommit: ${{ github.sha }}%0APrevious version: ${{ needs.preflight.outputs.previous_version }}" \
            -d "parse_mode=HTML"

  # ===========================================================================
  # NOTIFY
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-production, verify-deployment, create-release]
    if: always()
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.deploy-production.result }}" == "success" && \
                "${{ needs.verify-deployment.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=üöÄ" >> $GITHUB_OUTPUT
            echo "message=Production deployment successful!" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
            echo "message=Production deployment failed!" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "${{ steps.status.outputs.color }}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${{ steps.status.outputs.emoji }} SSI Shadow Production Deployment"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {"type": "mrkdwn", "text": "*Status:*\n${{ steps.status.outputs.message }}"},
                      {"type": "mrkdwn", "text": "*Version:*\n${{ needs.deploy-production.outputs.version }}"},
                      {"type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`"},
                      {"type": "mrkdwn", "text": "*Author:*\n${{ github.actor }}"}
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Production URLs:*\n‚Ä¢ Worker: ${{ needs.deploy-production.outputs.worker_url }}\n‚Ä¢ Dashboard: ${{ needs.deploy-production.outputs.dashboard_url }}"
                    }
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Send Telegram notification
        run: |
          STATUS="${{ steps.status.outputs.emoji }} <b>${{ steps.status.outputs.message }}</b>"
          MESSAGE="$STATUS%0A%0A<b>Version:</b> ${{ needs.deploy-production.outputs.version }}%0A<b>Commit:</b> ${{ github.sha }}%0A<b>Author:</b> ${{ github.actor }}%0A%0A<b>Worker:</b> ${{ needs.deploy-production.outputs.worker_url }}%0A<b>Dashboard:</b> ${{ needs.deploy-production.outputs.dashboard_url }}"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"
